<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Input Pembayaran Siswa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f0fff4;
    }
    .form-box {
      max-width: 500px;
      margin: 50px auto;
      padding: 30px;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .btn-green {
      background-color: #28a745;
      color: white;
    }
    .btn-yellow {
      background-color: #ffc107;
      color: black;
    }
  </style>
</head>
<body>
  <div class="form-box">
    <h4 class="text-center text-success mb-4">Input Pembayaran Siswa</h4>
    <form id="paymentForm">
      <div class="mb-3">
        <label for="kelas" class="form-label">Kelas</label>
        <select id="kelas" class="form-select" required>
          <option value="">-- Pilih Kelas --</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="siswa" class="form-label">Nama Siswa</label>
        <select id="siswa" class="form-select" required>
          <option value="">-- Pilih Siswa --</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="tanggal" class="form-label">Tanggal Pembayaran</label>
        <input type="date" id="tanggal" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="tagihan" class="form-label">Jenis Tagihan</label>
        <select id="tagihan" class="form-select" required>
          <option value="">-- Pilih Tagihan --</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="nominal" class="form-label">Nominal Bayar (Rp)</label>
        <input type="number" id="nominal" class="form-control" required />
      </div>
      <div class="d-flex justify-content-between">
        <button type="submit" class="btn btn-green">Simpan</button>
        <a href="dashboard.html" class="btn btn-danger">Batal</a>
      </div>
    </form>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxTE-XyLTXju9cAhDXwkuC2ry1XBcI2nkTYBkOJsy1YjPZBHyfUsWz786O_mlPPuPMw/exec";
    let dataSiswa = [];
    let dataTagihan = [];

    fetch(scriptURL)
      .then(res => res.json())
      .then(data => {
        dataSiswa = data.dataSiswa;
        dataTagihan = data.dataTagihan;

        const kelasList = [...new Set(dataSiswa.map(s => s.Kelas))];
        const kelasSelect = document.getElementById('kelas');
        kelasList.forEach(kelas => {
          kelasSelect.innerHTML += `<option value="${kelas}">${kelas}</option>`;
        });

        const tagihanSelect = document.getElementById('tagihan');
        dataTagihan.forEach(t => {
          tagihanSelect.innerHTML += `<option value="${t.Kode}">${t.Kode} - ${t.Nama} (${t.Nominal})</option>`;
        });
      });

    document.getElementById('kelas').addEventListener('change', function() {
      const kelasTerpilih = this.value;
      const siswaSelect = document.getElementById('siswa');
      siswaSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>';
      dataSiswa
        .filter(s => s.Kelas === kelasTerpilih)
        .forEach(s => {
          siswaSelect.innerHTML += `<option value="${s.NISN}">${s.Nama}</option>`;
        });
    });

    document.getElementById('paymentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const siswa = document.getElementById('siswa');
      const kelas = document.getElementById('kelas').value;
      const tanggal = document.getElementById('tanggal').value;
      const tagihan = document.getElementById('tagihan').value;
      const tagihanText = document.getElementById('tagihan').selectedOptions[0].text;
      const nominal = parseFloat(document.getElementById('nominal').value);

      const kodeTagihan = tagihan;
      const namaTagihan = tagihanText.split(" - ")[1]?.split(" (")[0] || "";
      const nominalTagihan = parseFloat(tagihanText.split("Rp")[1]?.replace(/[^\d]/g, "") || 0);

      let keterangan = "Lunas";
      if (nominal < nominalTagihan) keterangan = "Cicilan";
      else if (nominal > nominalTagihan) keterangan = "Lebih Bayar";

      const formData = new FormData();
      formData.append("NISN", siswa.value);
      formData.append("Nama", siswa.options[siswa.selectedIndex].text);
      formData.append("Kelas", kelas);
      formData.append("Tanggal", tanggal);
      formData.append("KodeTagihan", kodeTagihan);
      formData.append("NamaTagihan", namaTagihan);
      formData.append("Nominal", nominal);
      formData.append("Keterangan", keterangan);

      fetch(scriptURL, { method: "POST", body: formData })
        .then(response => alert("Pembayaran berhasil disimpan!"))
        .catch(error => alert("Terjadi kesalahan. Silakan coba lagi."));
    });
  </script>
</body>
</html>
