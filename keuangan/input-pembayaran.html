const SHEET_SISWA = 'DataSiswa';
const SHEET_TAGIHAN = 'Tagihan';
const SHEET_PEMBAYARAN = 'Pembayaran';

function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet();
  const siswaData = sheet.getSheetByName(SHEET_SISWA).getDataRange().getValues();
  const tagihanData = sheet.getSheetByName(SHEET_TAGIHAN).getDataRange().getValues();

  const kelasUnik = [...new Set(siswaData.slice(1).map(row => row[2]))]; // Ambil kelas
  const siswaPerKelas = {};

  kelasUnik.forEach(kelas => {
    siswaPerKelas[kelas] = siswaData.slice(1)
      .filter(row => row[2] === kelas)
      .map(row => ({ nama: row[1], nisn: row[0] }));
  });

  const tagihanList = tagihanData.slice(1).map(row => ({
    nama: row[0],
    nominal: row[1]
  }));

  return ContentService.createTextOutput(JSON.stringify({
    kelas: kelasUnik,
    siswa: siswaPerKelas,
    tagihan: tagihanList
  })).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_PEMBAYARAN);

  sheet.appendRow([
    new Date(),
    data.kelas,
    data.nama,
    data.nisn,
    data.jenis,
    data.nominal,
    data.keterangan || ''
  ]);

  return ContentService.createTextOutput('Sukses').setMimeType(ContentService.MimeType.TEXT);
}
